---
- name: Install App As Service
  hosts: clowe-app-webservers
  become: true

  tasks:
    - name: Ensure group exists
      ansible.builtin.group:
        name: "{{ item }}"
        state: present
      with_items:
        - clowe-app
        - docker

    - name: Add the user 'clowe-app' with a group of clowe-app and docker
      ansible.builtin.user:
        name: clowe-app
        comment: clowe-app user for running docker
        groups:
          - clowe-app
          - docker

    - name: Copy DRF files over
      ansible.builtin.copy:
        src: ../drf
        dest: /opt/clowe-app
        owner: clowe-app
        group: clowe-app
        mode: u+rw,g-wx,o-rwx

    - name: Copy docker files over
      ansible.builtin.copy:
        src: ../docker
        dest: /opt/clowe-app
        owner: clowe-app
        group: clowe-app
        mode: u+rwx,g-wx,o-rwx

    - name: Stop existing services
      community.docker.docker_compose_v2:
        project_src: /opt/clowe-app/docker/drf
        files:
          - docker-compose.yml
        state: stopped

    - name: Create and start services
      community.docker.docker_compose_v2:
        project_src: /opt/clowe-app/docker/drf
        files:
          - docker-compose.yml
        build: always
        state: present

    - name: run migrations
      ansible.builtin.shell: docker compose exec -it clowe-app python manage.py migrate
      args:
        chdir: /opt/clowe-app/docker/drf
